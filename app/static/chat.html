<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .chat-header {
            padding: 20px;
            background: var(--bot-color, #0066CC);
            color: white;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 20px;
            font-weight: 600;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            gap: 10px;
            max-width: 80%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: 600;
            font-size: 20px;
        }

        .message.user .message-avatar {
            background: #E3F2FD;
            color: #1976D2;
        }

        .message.assistant .message-avatar {
            background: var(--bot-color, #0066CC);
            color: white;
        }

        .message-content {
            background: #f5f5f5;
            padding: 12px 16px;
            border-radius: 12px;
            line-height: 1.6;
            word-wrap: break-word;
            position: relative;
        }

        .copy-button {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .message.assistant:hover .copy-button {
            opacity: 1;
        }

        .copy-button:hover {
            background: #f5f5f5;
            border-color: var(--bot-color, #0066CC);
        }

        .copy-button:active {
            transform: scale(0.95);
        }

        .message.user .message-content {
            background: var(--bot-color, #0066CC);
            color: white;
        }

        /* Markdown styles */
        .message-content h1 {
            font-size: 1.5em;
            font-weight: 600;
            margin: 12px 0 8px 0;
            border-bottom: 2px solid #ddd;
            padding-bottom: 4px;
        }

        .message-content h2 {
            font-size: 1.3em;
            font-weight: 600;
            margin: 10px 0 6px 0;
        }

        .message-content h3 {
            font-size: 1.1em;
            font-weight: 600;
            margin: 8px 0 4px 0;
        }

        .message-content h4 {
            font-size: 1.05em;
            font-weight: 600;
            margin: 8px 0 4px 0;
        }

        .message-content h5 {
            font-size: 1em;
            font-weight: 600;
            margin: 6px 0 3px 0;
        }

        .message-content h6 {
            font-size: 0.95em;
            font-weight: 600;
            margin: 6px 0 3px 0;
        }

        .message-content p {
            margin: 8px 0;
        }

        .message-content ul, .message-content ol {
            margin: 4px 0;
            padding-left: 24px;
        }

        .message-content li {
            margin: 0;
            line-height: 1.4;
        }

        .message-content strong {
            font-weight: 600;
        }

        .message-content em {
            font-style: italic;
        }

        .message-content code {
            background: rgba(0,0,0,0.08);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .message.user .message-content code {
            background: rgba(255,255,255,0.2);
        }

        .message-content pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .message-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }

        .message-content blockquote {
            border-left: 4px solid #ddd;
            padding-left: 12px;
            margin: 8px 0;
            color: #666;
        }

        .message.user .message-content h1,
        .message.user .message-content h2,
        .message.user .message-content h3 {
            border-color: rgba(255,255,255,0.3);
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: #f5f5f5;
            border-radius: 12px;
            width: fit-content;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* Suggestion styles */
        .suggestions-container {
            padding: 12px 16px;
            margin: 8px 0 16px 48px;
        }

        .suggestions-label {
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .suggestions-buttons {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .suggestion-button {
            background: white;
            border: 1.5px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 14px;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: all 0.2s;
            line-height: 1.4;
        }

        .suggestion-button:hover {
            background: #f5f5f5;
            border-color: var(--bot-color, #0066CC);
            color: var(--bot-color, #0066CC);
        }

        .suggestion-button:active {
            transform: scale(0.98);
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .input-container textarea {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #ddd;
            border-radius: 16px;
            font-size: 14px;
            outline: none;
            color: #333;
            background: white;
            font-family: inherit;
            resize: none;
            min-height: 46px;
            max-height: 200px;
            overflow-y: auto;
            line-height: 1.5;
        }

        .input-container textarea:focus {
            border-color: var(--bot-color, #0066CC);
        }

        .input-container button {
            padding: 12px 24px;
            background: var(--bot-color, #0066CC);
            color: white;
            border: none;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .input-container button:hover:not(:disabled) {
            opacity: 0.9;
        }

        .input-container button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .file-upload-btn {
            padding: 12px !important;
            background: #f5f5f5 !important;
            color: #666 !important;
            border: 1px solid #ddd !important;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload-btn:hover {
            background: #e8e8e8 !important;
            color: #333 !important;
        }

        .file-upload-btn svg {
            width: 20px;
            height: 20px;
        }

        .file-preview {
            padding: 8px 12px;
            background: #f0f7ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            font-size: 13px;
            color: #0066cc;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-preview button {
            background: none !important;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 0 4px !important;
            font-size: 18px;
            line-height: 1;
        }

        .file-preview button:hover {
            color: #c00;
        }

        .error-message {
            background: #FEE;
            color: #C00;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 10px 20px;
            text-align: center;
        }

        .greeting {
            text-align: center;
            color: #666;
            padding: 40px 20px;
        }

        .full-document-controls {
            padding: 12px 20px;
            background: #f9fafb;
            border-top: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toggle-container {
            display: flex;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .toggle-container input[type="checkbox"] {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--bot-color, #0066CC);
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #374151;
            font-weight: 500;
        }

        .toggle-label .icon {
            width: 18px;
            height: 18px;
            color: var(--bot-color, #0066CC);
        }

        .mode-hint {
            font-size: 12px;
            color: #6b7280;
            font-weight: 400;
            font-style: italic;
        }

        #document-selector {
            padding: 10px 14px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            color: #374151;
            background: white;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s;
        }

        #document-selector:focus {
            border-color: var(--bot-color, #0066CC);
        }

        #document-selector:disabled {
            background: #f3f4f6;
            color: #9ca3af;
            cursor: not-allowed;
        }

        #document-selector option {
            padding: 8px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1 id="chat-title">Chat</h1>
        </div>

        <div class="messages-container" id="messages">
            <div class="greeting" id="greeting">
                Start a conversation...
            </div>
        </div>

        <div id="file-preview-container" style="padding: 0 20px; display: none;"></div>

        <div class="full-document-controls" id="full-document-controls" style="display: none;">
            <label class="toggle-container">
                <input type="checkbox" id="full-document-toggle" onchange="toggleFullDocumentMode()">
                <span class="toggle-label">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    Full Document Mode
                    <span class="mode-hint">(retrieve entire document for outlines)</span>
                </span>
            </label>
            <select id="document-selector" disabled>
                <option value="">Select a document...</option>
            </select>
        </div>

        <div class="input-container">
            <input
                type="file"
                id="file-input"
                accept=".pdf,.txt,.md,.html,.htm,.doc,.docx,.jpg,.jpeg,.png,.gif,.webp,image/*"
                style="display: none;"
                onchange="handleFileSelect()"
            />
            <button class="file-upload-btn" onclick="document.getElementById('file-input').click()" title="Attach file">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                </svg>
            </button>
            <textarea
                id="message-input"
                placeholder="Type your message..."
                autocomplete="off"
                rows="1"
            ></textarea>
            <button id="send-btn" onclick="sendMessage()">Send</button>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        const botId = window.location.pathname.split('/').pop();
        let sessionId = localStorage.getItem(`session_${botId}`) || null;
        let isLoading = false;

        // Load bot configuration
        async function loadBotConfig() {
            try {
                const response = await fetch(`${API_BASE}/api/bots/${botId}/public`);
                const bot = await response.json();

                document.getElementById('chat-title').textContent = bot.widget_title || bot.name;
                document.title = `${bot.name} - by SageRock AI`;
                document.documentElement.style.setProperty('--bot-color', bot.widget_color);

                if (bot.widget_greeting) {
                    document.getElementById('greeting').textContent = bot.widget_greeting;
                }

                // Load available documents if bot uses Qdrant
                if (bot.use_qdrant && bot.qdrant_collection) {
                    await loadAvailableDocuments(bot.qdrant_collection);
                }
            } catch (error) {
                console.error('Failed to load bot config:', error);
            }
        }

        // Load available documents from Qdrant collection
        async function loadAvailableDocuments(collection) {
            try {
                const response = await fetch(`${API_BASE}/api/documents/collections/${collection}/documents`);
                if (!response.ok) return;

                const data = await response.json();

                if (data.documents && data.documents.length > 0) {
                    // Show the full document controls
                    document.getElementById('full-document-controls').style.display = 'flex';

                    // Populate the document selector
                    const selector = document.getElementById('document-selector');
                    selector.innerHTML = '<option value="">Select a document...</option>';

                    data.documents.forEach(doc => {
                        const option = document.createElement('option');
                        option.value = doc.filename;
                        option.textContent = `${doc.filename} (${doc.chunk_count} chunks)`;
                        selector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load documents:', error);
            }
        }

        // Toggle full document mode
        function toggleFullDocumentMode() {
            const checkbox = document.getElementById('full-document-toggle');
            const selector = document.getElementById('document-selector');

            if (checkbox.checked) {
                selector.disabled = false;
            } else {
                selector.disabled = true;
                selector.value = '';
            }
        }

        function parseMarkdown(text) {
            // Simple markdown parser for common formatting
            let html = text;

            // First, preserve code blocks to avoid parsing markdown inside them
            const codeBlocks = [];
            html = html.replace(/```([^`]+)```/g, (match, code) => {
                codeBlocks.push(code);
                return `__CODEBLOCK_${codeBlocks.length - 1}__`;
            });

            // Strip unwanted HTML tags that AI might generate (preserve <br> only)
            // Remove <pre>, <code>, <p>, and other formatting tags while preserving content
            html = html.replace(/<\/?pre[^>]*>/gi, '');
            html = html.replace(/<\/?code[^>]*>/gi, '');
            html = html.replace(/<p><\/p>/gi, ''); // Remove empty <p> tags
            html = html.replace(/<p>/gi, '\n\n'); // Convert <p> to double newline
            html = html.replace(/<\/p>/gi, ''); // Remove closing </p>

            // Escape HTML tags but preserve <br> tags
            html = html.replace(/<br\s*\/?>/gi, '__BR_TAG__');
            html = html.replace(/&/g, '&amp;')
                      .replace(/</g, '&lt;')
                      .replace(/>/g, '&gt;');
            html = html.replace(/__BR_TAG__/g, '<br>');

            // Parse tables (markdown format with | separators)
            html = html.replace(/^\|(.+)\|$/gim, (match, content) => {
                // Check if this is a separator line (|---|---|)
                if (/^[\s\-:|]+$/.test(content)) {
                    return '__TABLE_SEPARATOR__';
                }
                // Parse table cells
                const cells = content.split('|').map(cell => cell.trim()).filter(cell => cell);
                return '__TABLE_ROW__' + cells.map(cell => `<td>${cell}</td>`).join('') + '__TABLE_ROW_END__';
            });

            // Group table rows into tables (include separator in match)
            html = html.replace(/((?:__TABLE_ROW__.+?__TABLE_ROW_END__|__TABLE_SEPARATOR__)\n?)+/g, (match) => {
                const rows = match.split(/\n/).filter(r => r.trim());
                let isFirstRow = true;
                let tableHtml = '<table style="border-collapse: collapse; width: 100%; margin: 12px 0;">';

                rows.forEach(row => {
                    if (row === '__TABLE_SEPARATOR__' || row.includes('__TABLE_SEPARATOR__')) {
                        isFirstRow = false;
                        return;
                    }
                    const cleanRow = row.replace('__TABLE_ROW__', '').replace('__TABLE_ROW_END__', '');
                    if (cleanRow.trim()) {
                        if (isFirstRow) {
                            tableHtml += '<thead><tr>' + cleanRow.replace(/<td>/g, '<th style="border: 1px solid #ddd; padding: 8px; background: #f5f5f5; font-weight: 600; text-align: left;">').replace(/<\/td>/g, '</th>') + '</tr></thead><tbody>';
                            isFirstRow = false;
                        } else {
                            tableHtml += '<tr>' + cleanRow.replace(/<td>/g, '<td style="border: 1px solid #ddd; padding: 8px;">') + '</tr>';
                        }
                    }
                });

                tableHtml += '</tbody></table>';
                return tableHtml;
            });

            // Restore code blocks
            codeBlocks.forEach((code, i) => {
                html = html.replace(`__CODEBLOCK_${i}__`, `<pre><code>${code}</code></pre>`);
            });

            // Inline code (`code`)
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // Bold (**text** or __text__)
            html = html.replace(/\*\*([^\*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/__([^_]+)__/g, '<strong>$1</strong>');

            // Italic (*text* or _text_)
            html = html.replace(/\*([^\*]+)\*/g, '<em>$1</em>');
            html = html.replace(/_([^_]+)_/g, '<em>$1</em>');

            // Headers (h6 to h1, process in reverse order to handle longer matches first)
            html = html.replace(/^###### (.*$)/gim, '<h6>$1</h6>');
            html = html.replace(/^##### (.*$)/gim, '<h5>$1</h5>');
            html = html.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
            html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
            html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
            html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');

            // Lists
            html = html.replace(/^\* (.*$)/gim, '<li>$1</li>');
            html = html.replace(/^- (.*$)/gim, '<li>$1</li>');

            // Wrap consecutive <li> tags in <ul>
            html = html.replace(/(<li>.*<\/li>\n?)+/g, function(match) {
                return '<ul>' + match + '</ul>';
            });

            // Line breaks
            html = html.replace(/\n\n/g, '</p><p>');
            html = html.replace(/\n/g, '<br>');

            // Wrap in paragraph if not already wrapped
            if (!html.startsWith('<h') && !html.startsWith('<ul') && !html.startsWith('<pre') && !html.startsWith('<table')) {
                html = '<p>' + html + '</p>';
            }

            return html;
        }

        function addMessage(role, content) {
            const messagesContainer = document.getElementById('messages');
            const greeting = document.getElementById('greeting');

            if (greeting) {
                greeting.remove();
            }

            // Remove any previous suggestions before adding new message
            const oldSuggestions = document.querySelector('.suggestions-container');
            if (oldSuggestions) {
                oldSuggestions.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? '👤' : '🤖';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // Parse suggestions for assistant messages
            let suggestions = [];
            let mainContent = content;

            if (role === 'assistant' && content.includes('---SUGGESTIONS---')) {
                const parts = content.split('---SUGGESTIONS---');
                mainContent = parts[0].trim();
                const suggestionsText = parts[1].trim();
                suggestions = suggestionsText.split('\n').filter(s => s.trim()).map(s => s.trim());
            }

            // Parse markdown for assistant messages, plain text for user messages
            if (role === 'assistant') {
                contentDiv.innerHTML = parseMarkdown(mainContent);

                // Add copy button for assistant messages
                const copyButton = document.createElement('button');
                copyButton.className = 'copy-button';
                copyButton.innerHTML = '📋 Copy';
                copyButton.onclick = (e) => {
                    e.stopPropagation();
                    navigator.clipboard.writeText(mainContent).then(() => {
                        copyButton.innerHTML = '✓ Copied';
                        setTimeout(() => {
                            copyButton.innerHTML = '📋 Copy';
                        }, 2000);
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                    });
                };
                contentDiv.appendChild(copyButton);
            } else {
                contentDiv.textContent = content;
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);

            messagesContainer.appendChild(messageDiv);

            // Add suggestions if any
            if (suggestions.length > 0) {
                const suggestionsContainer = document.createElement('div');
                suggestionsContainer.className = 'suggestions-container';
                suggestionsContainer.innerHTML = '<div class="suggestions-label">💡 Suggested questions:</div>';

                const buttonsDiv = document.createElement('div');
                buttonsDiv.className = 'suggestions-buttons';

                suggestions.forEach(suggestion => {
                    const button = document.createElement('button');
                    button.className = 'suggestion-button';
                    button.textContent = suggestion;
                    button.onclick = () => {
                        document.getElementById('message-input').value = suggestion;
                        sendMessage();
                    };
                    buttonsDiv.appendChild(button);
                });

                suggestionsContainer.appendChild(buttonsDiv);
                messagesContainer.appendChild(suggestionsContainer);
            }

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTyping(show) {
            const messagesContainer = document.getElementById('messages');
            let typingIndicator = document.getElementById('typing-indicator');

            if (show && !typingIndicator) {
                typingIndicator = document.createElement('div');
                typingIndicator.id = 'typing-indicator';
                typingIndicator.className = 'message assistant';
                typingIndicator.innerHTML = `
                    <div class="message-avatar">🤖</div>
                    <div class="typing-indicator" style="display: block;">
                        <span></span><span></span><span></span>
                    </div>
                `;
                messagesContainer.appendChild(typingIndicator);
            } else if (!show && typingIndicator) {
                typingIndicator.remove();
            }

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        let selectedFile = null;

        function handleFileSelect() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];

            if (file) {
                // Validate file size (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    alert('File too large. Maximum size is 10MB.');
                    fileInput.value = '';
                    return;
                }

                selectedFile = file;
                showFilePreview(file.name);
            }
        }

        function showFilePreview(filename) {
            const container = document.getElementById('file-preview-container');
            container.style.display = 'block';

            // Check if it's an image
            const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(filename);

            if (isImage && selectedFile) {
                // Show image preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    container.innerHTML = `
                        <div class="file-preview" style="flex-direction: column; align-items: flex-start; gap: 8px; padding: 12px;">
                            <div style="display: flex; align-items: center; gap: 8px; width: 100%;">
                                <span>🖼️ ${filename}</span>
                                <button onclick="clearFile()" title="Remove file">&times;</button>
                            </div>
                            <img src="${e.target.result}" style="max-width: 200px; max-height: 150px; border-radius: 4px; border: 1px solid #ddd;">
                        </div>
                    `;
                };
                reader.readAsDataURL(selectedFile);
            } else {
                // Show file icon for documents
                container.innerHTML = `
                    <div class="file-preview">
                        <span>📎 ${filename}</span>
                        <button onclick="clearFile()" title="Remove file">&times;</button>
                    </div>
                `;
            }
        }

        function clearFile() {
            selectedFile = null;
            document.getElementById('file-input').value = '';
            document.getElementById('file-preview-container').style.display = 'none';
        }

        async function sendMessage() {
            const input = document.getElementById('message-input');
            const sendBtn = document.getElementById('send-btn');
            const message = input.value.trim();

            if (!message || isLoading) return;

            // Disable input
            isLoading = true;
            input.disabled = true;
            sendBtn.disabled = true;

            // Add user message (with file indicator if present)
            let displayMessage = message;
            if (selectedFile) {
                displayMessage = `${message}\n[Attached: ${selectedFile.name}]`;
            }
            addMessage('user', displayMessage);
            input.value = '';

            // Show typing indicator
            showTyping(true);

            try {
                // Create FormData for file upload
                const formData = new FormData();
                formData.append('message', message);
                if (sessionId) {
                    formData.append('session_id', sessionId);
                }
                if (selectedFile) {
                    formData.append('file', selectedFile);
                }

                // Build URL with full_document parameter if enabled
                let chatUrl = `${API_BASE}/api/chat/${botId}`;
                const fullDocToggle = document.getElementById('full-document-toggle');
                const docSelector = document.getElementById('document-selector');

                if (fullDocToggle && fullDocToggle.checked && docSelector.value) {
                    chatUrl += `?full_document=${encodeURIComponent(docSelector.value)}`;
                }

                const response = await fetch(chatUrl, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) throw new Error('Failed to get response');

                const data = await response.json();

                // Save session ID
                if (data.session_id) {
                    sessionId = data.session_id;
                    localStorage.setItem(`session_${botId}`, sessionId);
                }

                // Hide typing and show response
                showTyping(false);
                addMessage('assistant', data.response);

                // Clear file after successful send
                if (selectedFile) {
                    clearFile();
                }
            } catch (error) {
                showTyping(false);
                addMessage('assistant', 'Sorry, I encountered an error. Please try again.');
                console.error('Chat error:', error);
            } finally {
                isLoading = false;
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        // Auto-resize textarea as user types
        const textarea = document.getElementById('message-input');
        textarea.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px';
        });

        // Enter key to send (Shift+Enter for new line)
        textarea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Load bot config on start
        loadBotConfig();
    </script>
</body>
</html>
